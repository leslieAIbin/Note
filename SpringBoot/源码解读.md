---
typora-root-url: /images
---



# SpringBoot 源码解读

# 项目环境准备

![](/1.png)

前端传过来的请求，会经过分发器，找到一个合适的控制器，然后会获得一个model，然后赋予给视图层，然后渲染给用户

Spring框架：



![](/2.png)

MyBatis： orm 关系型数据库 

![](/3.png)

idea创建一个ssm项目

![](/4.png)

![](/5.png)

## 直接上手SpringBoot2 + Mybatis





![](/6.png)

### pom.xml

服务器数据库5.x 就用虚拟机那个环境

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.1.7.RELEASE</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>

	<groupId>com.example</groupId>
	<artifactId>demo</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>sb2</name>
	<description>Demo project for Spring Boot</description>

	<properties>
		<java.version>1.8</java.version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>

		<dependency>
			<groupId>org.mybatis.spring.boot</groupId>
			<artifactId>mybatis-spring-boot-starter</artifactId>
			<version>1.3.3</version>
		</dependency>

<!--			<dependency>-->
<!--				<groupId>mysql</groupId>-->
<!--				<artifactId>mysql-connector-java</artifactId>-->
<!--				<version>8.0.13</version>-->
<!--			</dependency>-->

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
			<exclusions>
				<exclusion>
					<groupId>org.junit.vintage</groupId>
					<artifactId>junit-vintage-engine</artifactId>
				</exclusion>
			</exclusions>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.mybatis.generator</groupId>
				<artifactId>mybatis-generator-maven-plugin</artifactId>
				<version>1.3.5</version>
				<dependencies>
					<dependency>
						<groupId>mysql</groupId>
						<artifactId>mysql-connector-java</artifactId>
						<version>5.1.8</version>
					</dependency>
				</dependencies>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>

</project>

```

一定要注意各种版本号

### generatorConfig.xml

```xml
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE generatorConfiguration        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"><generatorConfiguration>    <context id="testTables" targetRuntime="MyBatis3">        <commentGenerator>            <!-- 是否去除自动生成的注释 true：是 ： false:否 -->            <property name="suppressAllComments" value="true"/>        </commentGenerator>        <!--数据库连接的信息：驱动类、连接地址、用户名、密码 -->        <jdbcConnection driverClass="com.mysql.jdbc.Driver"                        connectionURL="jdbc:mysql://192.168.56.101:3306/test" userId="root"                        password="123456">        </jdbcConnection>        <!-- 默认false，把JDBC DECIMAL 和 NUMERIC 类型解析为 Integer，为 true时把JDBC DECIMAL 和            NUMERIC 类型解析为java.math.BigDecimal -->        <javaTypeResolver>            <property name="forceBigDecimals" value="false"/>        </javaTypeResolver>        <!-- targetProject:生成PO类的位置 -->        <javaModelGenerator targetPackage="com.example.sb2.bean"                            targetProject="src/main/java">            <!-- enableSubPackages:是否让schema作为包的后缀 -->            <property name="enableSubPackages" value="false"/>            <!-- 从数据库返回的值被清理前后的空格 -->            <property name="trimStrings" value="true"/>        </javaModelGenerator>        <!-- targetProject:mapper映射文件生成的位置 -->        <sqlMapGenerator targetPackage="mapper"                         targetProject="src/main/resources">            <!-- enableSubPackages:是否让schema作为包的后缀 -->            <property name="enableSubPackages" value="false"/>        </sqlMapGenerator>        <!-- targetPackage：mapper接口生成的位置 -->        <javaClientGenerator type="XMLMAPPER"                             targetPackage="com.example.sb2.mapper"                             targetProject="src/main/java">            <!-- enableSubPackages:是否让schema作为包的后缀 -->            <property name="enableSubPackages" value="false"/>        </javaClientGenerator>        <!-- 指定数据库表 -->        <table schema="" tableName="demo"></table>    </context></generatorConfiguration>
```

### 属性配置

```
server.port=8080spring.datasource.username=rootspring.datasource.password=123456spring.datasource.url=jdbc:mysql://192.168.56.101:3306/test?useUnicode=true&characterEncoding=utf8&serverTimezone=GMTspring.datasource.driver-class-name=com.mysql.jdbc.Drivermybatis.mapper-locations=classpath:mapper/*.xmlmybatis.type-aliases-package=com.example.sb2.beanmybatis.configuration.map-underscore-to-camel-case=true
```

重写demo 实体类的 toString方法

### service

```java
package com.example.sb2.service;import com.example.sb2.bean.Demo;import com.example.sb2.mapper.DemoMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;import java.util.Optional;@Componentpublic class DemoService {    @Autowired    private DemoMapper demoMapper;    public Demo getDemoById(Long id) {        return Optional.ofNullable(demoMapper.selectByPrimaryKey(id)).orElse(null);    }}
```

### 控制器

```java
package com.example.sb2.controller;import com.example.sb2.bean.Demo;import com.example.sb2.service.DemoService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.PathVariable;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.ResponseBody;import java.util.Optional;@Controller@RequestMapping("/demo")public class DemoController {    @Autowired    private DemoService demoService;    @RequestMapping("/hello/{id}")    @ResponseBody    public String hello(@PathVariable(value = "id") Long id) {        return Optional.ofNullable(demoService.getDemoById(id)).map(Demo::toString).orElse("empty String");    }}
```

### sb2搭建流程

![](/7.png)

**总结：**

耗时短

配置文件简洁

不关注版本管理

易上手

# 启动流程的介绍

SpringBoot2 的启动流程

一行来完成启动

```java
@SpringBootApplication@MapperScan("com.example.sb2.mapper")
public class Sb2Application {   
    public static void main(String[] args) {      
        SpringApplication.run(Sb2Application.class, args);   
    }}
```

run方法点进去  SpringApplication + run

SpringApplication 是进行一些赋值

```java
	public SpringApplication(ResourceLoader resourceLoader, Class<?>... primarySources) {
		this.resourceLoader = resourceLoader;
		Assert.notNull(primarySources, "PrimarySources must not be null");
		this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));
		this.webApplicationType = WebApplicationType.deduceFromClasspath();
		setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
		setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
		this.mainApplicationClass = deduceMainApplicationClass();
	}	public static ConfigurableApplicationContext run(Class<?>[] primarySources, String[] args) {
		return new SpringApplication(primarySources).run(args);
	}
```

run 方法

```
public ConfigurableApplicationContext run(String... args) {
		StopWatch stopWatch = new StopWatch();
		stopWatch.start();
		ConfigurableApplicationContext context = null;
		Collection<SpringBootExceptionReporter> exceptionReporters = new ArrayList<>();
		configureHeadlessProperty();
		SpringApplicationRunListeners listeners = getRunListeners(args);
		listeners.starting();
		try {
			ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);
			ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);
			configureIgnoreBeanInfo(environment);
			Banner printedBanner = printBanner(environment);
			context = createApplicationContext();
			exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,
					new Class[] { ConfigurableApplicationContext.class }, context);
			prepareContext(context, environment, listeners, applicationArguments, printedBanner);
			refreshContext(context);
			afterRefresh(context, applicationArguments);
			stopWatch.stop();
			if (this.logStartupInfo) {
				new StartupInfoLogger(this.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);
			}
			listeners.started(context);
			callRunners(context, applicationArguments);
		}
		catch (Throwable ex) {
			handleRunFailure(context, ex, exceptionReporters, listeners);
			throw new IllegalStateException(ex);
		}

		try {
			listeners.running(context);
		}
		catch (Throwable ex) {
			handleRunFailure(context, ex, exceptionReporters, null);
			throw new IllegalStateException(ex);
		}
		return context;
	}
```



## 启动流程

* 框架初始化

* 框架启动

* 自动化装配

  

## 框架初始化步骤

* 加载资源 resource 读取

* 传过来的主类，一般是主类

* 1.x 环境只有两个（标准+web） 2.x多了一个reactive 环境

* 监听器用来监听关键事件

* 配置main方法所在类，一般和primarySources是一样

  

![](/8.png)

有一个计时器，项目启动之后，会在控制台上打印配置的时间

headless 实际上是就是设置系统属性java.awt.headless，在我们的例子中该属性会被设置为true，因为我们开发的是服务器程序，一般运行在没有显示器和键盘的环境。关于java中的headless模式，更多信息可以参考[这里](http://www.oracle.com/technetwork/articles/javase/headless-136834.html)。

配置上下文环境

刷新上下文：调用的是spring里的方法，加载bean

![](/9.png)

## 框架自动化装配的步骤

![](/10.png)

  ### 整体流程概览

用mindmaster来画图

这个部分图片太大了，直接用mindmaster来看

